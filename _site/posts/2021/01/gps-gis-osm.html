

<!doctype html>
<html lang="en" class="no-js">
  <head>
    

<meta charset="utf-8">



<!-- begin SEO -->









<title>Finding Backcountry Campsites with CalTopo, OpenStreetMap, and R - Crystal A. Mariano</title>







<meta property="og:locale" content="en-US">
<meta property="og:site_name" content="Crystal A. Mariano">
<meta property="og:title" content="Finding Backcountry Campsites with CalTopo, OpenStreetMap, and R">


  <link rel="canonical" href="http://localhost:4000/posts/2021/01/gps-gis-osm">
  <meta property="og:url" content="http://localhost:4000/posts/2021/01/gps-gis-osm">



  <meta property="og:description" content="Like many people, I’ve been spending more time outdoors during this pandemic.While this means daily walks in my neighborhood, it also means getting out intothe wilderness and sleeping in a tent when I can. Although outdoor recreationis one of the safer ways to entertain yourself these days, it’s not without itsown concerns. The difficulty ofsafely getting to trailheads means that while I’m backpacking more than usual,it’s still not as often as I’d like.">





  

  



  <meta property="og:image" content="http://localhost:4000/images/posts/gps-gis-osm/plot_final-1.png">



  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2021-01-04T00:00:00-06:00">






  <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "http://localhost:4000",
      "logo": "http://localhost:4000/images/profile.png"
    }
  </script>



  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "Crystal A. Mariano",
      "url" : "http://localhost:4000",
      "sameAs" : null
    }
  </script>






<!-- end SEO -->


<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Crystal A. Mariano Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">

<meta http-equiv="cleartype" content="on">
    

<!-- start custom head snippets -->

<link rel="apple-touch-icon" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72.png?v=20201130">
<link rel="apple-touch-icon" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114.png?v=20201130">
<link rel="apple-touch-icon" sizes="120x120" href="http://localhost:4000/images/apple-touch-icon-120x120.png?v=20201130">
<link rel="apple-touch-icon" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144.png?v=20201130">
<link rel="apple-touch-icon" sizes="152x152" href="http://localhost:4000/images/apple-touch-icon-152x152.png?v=20201130">
<link rel="apple-touch-icon" sizes="180x180" href="http://localhost:4000/images/apple-touch-icon-180x180.png?v=20201130">
<link rel="icon" type="image/png" href="http://localhost:4000/images/favicon-32x32.png?v=20201130" sizes="32x32">
<link rel="icon" type="image/png" href="http://localhost:4000/images/android-chrome-192x192.png?v=20201130" sizes="192x192">
<link rel="icon" type="image/png" href="http://localhost:4000/images/favicon-16x16.png?v=20201130" sizes="16x16">
<link rel="manifest" href="http://localhost:4000/images/manifest.json?v=20201130">
<link rel="mask-icon" href="http://localhost:4000/images/safari-pinned-tab.svg?v=20201130" color="#000000">
<link rel="shortcut icon" href="/images/favicon.ico?v=20201130">
<meta name="msapplication-TileColor" content="#000000">
<meta name="msapplication-TileImage" content="http://localhost:4000/images/mstile-150x150.png?v=20201130">
<meta name="msapplication-config" content="http://localhost:4000/images/browserconfig.xml?v=20201130">
<meta name="theme-color" content="#ffffff">
<link rel="stylesheet" href="http://localhost:4000/assets/css/academicons.css"/>

<script type="text/x-mathjax-config"> MathJax.Hub.Config({ TeX: { equationNumbers: { autoNumber: "all" } } }); </script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    TeX: {
      equationNumbers: {
        autoNumber: "AMS"
      }
    },
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/latest.js?config=TeX-MML-AM_CHTML' async></script>

<!-- end custom head snippets -->

  </head>

  <body>

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->
    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <button><div class="navicon"></div></button>
        <ul class="visible-links">
          <li class="masthead__menu-item masthead__menu-item--lg"><a href="http://localhost:4000/">Crystal A. Mariano</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/research/">Research</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/publications/">Publications</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/teaching/">Teaching</a></li>
          
            
            <li class="masthead__menu-item"><a href="http://localhost:4000/cv/">CV</a></li>
          
        </ul>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    





<div id="main" role="main">
  
  <div class="sidebar sticky">
  



<div itemscope itemtype="http://schema.org/Person">

  <div class="author__avatar">
    
    	<img src="http://localhost:4000/images/profile.png" class="author__avatar" alt="Crystal A. Mariano">
    
  </div>

  <div class="author__content">
    <h3 class="author__name">Crystal A. Mariano</h3>
    <p class="author__bio"><ul style="padding: 0;list-style-type: none;"><li style="margin: 0;"><b>NSF GRFP Fellow</b></li><li style="margin: 0;">Mechanical Engineering</li> <li style="margin: 0;">Bioengineering, B.S.</li></ul></p>
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
      
      
      
        <li><a href="mailto:cmari010@ucr.edu"><i class="fas fa-fw fa-envelope" aria-hidden="true" style="padding-right: 1.5em;"></i>Email</a></li>
      
      
       
      
      
      
      
        <li><a href="https://www.linkedin.com/in/crystal-a-mariano"><i class="fab fa-fw fa-linkedin" aria-hidden="true" style="padding-right: 1.5em;"></i>LinkedIn</a></li>
      
      
      
      
      
      
        <li><a href="https://github.com/crystalamariano"><i class="fab fa-fw fa-github" aria-hidden="true" style="padding-right: 1.5em;"></i>GitHub</a></li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
        <li><a href="http://orcid.org/0000-0001-5765-4193"><i class="ai ai-orcid ai-fw" aria-hidden="true" style="padding-right: 1.5em;"></i>ORCID</a></li>
      
      
        <li><a href="https://scholar.google.com/citations?user=6p4xG5MAAAAJ&hl=en&oi=ao"><i class="fas fa-fw fa-graduation-cap" aria-hidden="true" style="padding-right: 1.5em;"></i>Google Scholar</a></li>
      
      
      
      
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Finding Backcountry Campsites with CalTopo, OpenStreetMap, and R">
    <meta itemprop="description" content="Like many people, I’ve been spending more time outdoors during this pandemic.While this means daily walks in my neighborhood, it also means getting out intothe wilderness and sleeping in a tent when I can. Although outdoor recreationis one of the safer ways to entertain yourself these days, it’s not without itsown concerns. The difficulty ofsafely getting to trailheads means that while I’m backpacking more than usual,it’s still not as often as I’d like.">
    <meta itemprop="datePublished" content="January 04, 2021">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Finding Backcountry Campsites with CalTopo, OpenStreetMap, and R
</h1>
          
        
        
        
          <p class="page__date">
            <i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="1900-01-01T00:00:00-06:00">January 04, 2021</time>
            <span style="float:right;"><i class="fa fa-clock" aria-hidden="true"></i> 


  
	  32 minute read
	
</span>
          </p>
        
        
             
        
    
        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-align-justify"></i> On This Page</h4></header>
              <ul class="toc__menu"><li><a href="#backcountry-camping">Backcountry camping</a><ul><li><a href="#disclaimer">Disclaimer</a></li></ul></li><li><a href="#getting-the-data">Getting the data</a><ul><li><a href="#trails">Trails</a><ul><li><a href="#dont-get-lost">Don’t get lost</a></li><li><a href="#the-whole-trail">The whole trail</a></li></ul></li><li><a href="#water">Water</a></li><li><a href="#roads">Roads</a></li></ul></li><li><a href="#campsites">Campsites</a></li><li><a href="#elevation">Elevation</a></li><li><a href="#plan-it">Plan it</a></li></ul>

            </nav>
          </aside>
        
        <p>Like many people, I’ve been spending more time outdoors during this pandemic.
While this means daily walks in my neighborhood, it also means getting out into
the wilderness and sleeping in a tent when I can. Although outdoor recreation
is one of the safer ways to entertain yourself these days, it’s not without its
own <a href="https://www.recreateresponsibly.org/home">concerns</a>. The difficulty of
safely getting to trailheads means that while I’m backpacking more than usual,
it’s still not as often as I’d like.</p>

<!--more-->

<p>That means I’m spending a decent chunk of time thinking about and planning
future trips. At some point in the process of doing this, I realized that I
could use the GIS skills from my day job to help make planning future trips more
efficient. In this post I walk through how you can use GIS tools in R to help
with some of the route planning for a multiday backpacking trip. Specifically,
how you can use open source spatial data on geography and transportation
infrastructure to identify potential campsites along a hiking trail.</p>

<p>This was largely an exercise in seeing how I could apply GIS skills I’ve learned
in the study of political violence to small-scale GPS navigation. I haven’t had
the opportunity to hit the trail and test out any of the assumptions I use in
this process yet, so you should view this post as more of a (loose) method than
concrete suggestions. For a short and simple point-to-point hike with only one
route, there’s really no need to engage in this level of GIS analysis. I’ve kept
things simple to make them easier to follow, but this approach could actually be
useful and save some time when planning a longer trip with many potential
routes.</p>

<h1 id="backcountry-camping">Backcountry camping</h1>

<p>At some point in the future, I want to hike the
<a href="https://en.wikipedia.org/wiki/Uwharrie_Trail">Uwharrie Trail</a> in
<a href="https://en.wikipedia.org/wiki/Uwharrie_National_Forest">Uwharrie National Forest</a>
in central North Carolina, near where I went to grad school. As I think about
this (probably far off) trip, I’ve been using CalTopo to plan my route.</p>

<p>If you spend any amount of time in the outdoors, you should know about
<a href="https://caltopo.com/">CalTopo</a>. CalTopo is a website that lets you plan routes
(hiking, skiing, rafting, etc.) on top of super high resolution topographic
maps. You can then turn your smartphone into a full-featured GPS and use it to
follow those routes (CalTopo offes a mobile app, as does
<a href="https://www.gaiagps.com/">Gaia GPS</a>, both for about $20 a year). While the
Uwharrie Trail is a pretty straightforward hike, I’ve been using this as an
excuse to try and apply my GIS skills in a new context.</p>

<p>CalTopo is great, but it’s very point and click. I like doing things
programmatically when I can, so that means it’s time to grab some of the open
source data that CalTopo uses so we can play around with it in R. The base map
in CalTopo is called MapBuilder Topo, and uses
<a href="https://help.caltopo.com/discussions/maps/2464-mapbuilder-raw-data">OpenStreetMap data</a>
as its starting point, so let’s start there.</p>

<h2 id="disclaimer">Disclaimer</h2>

<p>This guide is intended to show how to identify <em>potential</em> backcountry campsites
on public land where dispersed camping is permitted. If you are backpacking in
an area with designated, maintained backcountry campsites, you should use them.
Dispersed camping is typically permitted in less-traveled areas where the impact
of campers is better minimized by diffusing it rather than concentrating it into
a handful of designated sites.<sup id="fnref:dispersed" role="doc-noteref"><a href="#fn:dispersed" class="footnote" rel="footnote">1</a></sup></p>

<p>Always check regulations for any land you plan to camp on to see if there are
specific requirements for site selection or areas where camping is prohibited.
Picking an <em>actual</em> campsite requires identifying areas where your saftey will
be maximized and the longterm impact of your stay will be minimized. See
<a href="https://wilderness.net/learn-about-wilderness/benefits/outdoor-recreation/camping/where-to-camp.php">this guide</a>
for the basics and
<a href="https://andrewskurka.com/tag/five-star-campsite-selection/">this series</a>
for a slightly more hardcore set of principles to follow. And remember, never go
into the wilderness without telling someone where you’re going and when you
should be back.</p>

<h1 id="getting-the-data">Getting the data</h1>

<p><a href="https://en.wikipedia.org/wiki/OpenStreetMap">OpenStreetMap</a> (OSM) is an open source
map of the entire globe; think of it as a hybrid of Google Maps and Wikipedia.
OSM is designed so that anyone can easily add to or edit it. Setting aside the
normative value of this perspective, this is helpful for us because it means
that OSM is transparent. We can use the excellent <code class="language-plaintext highlighter-rouge">osmdata</code>
<a href="https://docs.ropensci.org/osmdata/">R package</a> to query OSM via the
[Overpass API], and we can use OSM itself via the
<a href="https://www.openstreetmap.org/">OSM website</a> to learn the various parameters
we’ll use to query OSM.</p>

<h2 id="trails">Trails</h2>

<p>The
<a href="https://docs.ropensci.org/osmdata/articles/osmdata.html">getting started vignette</a>
covers much of the basics of using <code class="language-plaintext highlighter-rouge">osmdata</code>. The key functions are
<code class="language-plaintext highlighter-rouge">osmdata::opq()</code>, which builds a query to the Overpass API, and
<code class="language-plaintext highlighter-rouge">osmdata::add_osm_feature()</code>, which requests specific features. OSM classifies
features using
<a href="https://en.wikipedia.org/wiki/Key%E2%80%93value_database">key-value pairs</a>,
and we can use the OSM website to figure out just which pairs we need. Navigate
to an area of interest, right-click on the feature of interest, and then select
“query features.”</p>

<p><img src="/images/posts/gps-gis-osm/ut_query.png" alt="" /></p>

<p>Next, select the desired feature in the dialog on the left of the screen. In
this case, select the “Relation” rather than the “Path” because the path will
only include one segment of the trail while the relation will include its entire
length.</p>

<p><img src="/images/posts/gps-gis-osm/ut_select.png" alt="" /></p>

<p>We can see here that the Uwharrie Trail relation has <code class="language-plaintext highlighter-rouge">type=hiking</code>, so that’s
the key-value pair wew’ll have to specify in our query.</p>

<p><img src="/images/posts/gps-gis-osm/ut_rel.png" alt="" /></p>

<p>Make sure to use the <code class="language-plaintext highlighter-rouge">bbox</code> argument to <code class="language-plaintext highlighter-rouge">osmdata::opq()</code>, otherwise you’ll
request every hiking trail in the world! You can manually specify the four
edges of a bounding box to search in, or you can use the <code class="language-plaintext highlighter-rouge">osmdata::getbb()</code>
function to get it automatically using the
<a href="https://wiki.openstreetmap.org/wiki/Nominatim">Nominatim</a> geocoder.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">sf</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">osmdata</span><span class="p">)</span><span class="w">

</span><span class="c1">## get hiking routes in Uwharrie National Forest</span><span class="w">
</span><span class="n">unf_trails</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">opq</span><span class="p">(</span><span class="n">bbox</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getbb</span><span class="p">(</span><span class="s1">'uwharrie national forest usa'</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">add_osm_feature</span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'route'</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'hiking'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">osmdata_sf</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<p>Notice that we use the <code class="language-plaintext highlighter-rouge">osmdata::osmdata_sf()</code> function to convert the resulting
object for use with the <code class="language-plaintext highlighter-rouge">sf</code> R package. Let’s inspect the resulting object of
class <code class="language-plaintext highlighter-rouge">osmdata_sf</code>.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## inspect</span><span class="w">
</span><span class="n">unf_trails</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Object of class 'osmdata' with:
##                  $bbox : 35.3951403,-80.0236608,35.4351403,-79.9836608
##         $overpass_call : The call submitted to the overpass API
##                  $meta : metadata including timestamp and version numbers
##            $osm_points : 'sf' Simple Features Collection with 3341 points
##             $osm_lines : 'sf' Simple Features Collection with 26 linestrings
##          $osm_polygons : 'sf' Simple Features Collection with 0 polygons
##        $osm_multilines : 'sf' Simple Features Collection with 1 multilinestrings
##     $osm_multipolygons : NULL
</code></pre></div></div>

<p>We can see that the <code class="language-plaintext highlighter-rouge">unf_trails</code> object includes points, lines, polygons,
multilines, and multipolygons. We want to use the lines since that will include
any short trail segments that aren’t part of a larger trail. We can easily plot
the trails using this object.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## plot</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">unf_trails</span><span class="o">$</span><span class="n">osm_lines</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'coral4'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/images/posts/gps-gis-osm/plot_trails-1.png" style="display: block; margin: auto;" /></p>

<h3 id="dont-get-lost">Don’t get lost</h3>

<p>Let’s do some quick sanity checks. First, Wikipedia tells us the trail should be
about 20 miles. We can use the <code class="language-plaintext highlighter-rouge">sf::st_length()</code> function to measure the length
of each trail segment, and the <code class="language-plaintext highlighter-rouge">sf::st_union()</code> function to combine all
segments. We’ll get our answer in meters, which as a metric-deprived American,
won’t be all that helpful to me. To get around this, we can use the
`<code class="language-plaintext highlighter-rouge">units::st_units()</code> function to convert from meters to miles.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## measure total trail length</span><span class="w">
</span><span class="n">st_union</span><span class="p">(</span><span class="n">unf_trails</span><span class="o">$</span><span class="n">osm_lines</span><span class="o">$</span><span class="n">geometry</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="c1"># combine all segments.</span><span class="w">
  </span><span class="n">st_length</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="c1"># measure length</span><span class="w">
  </span><span class="n">units</span><span class="o">::</span><span class="n">set_units</span><span class="p">(</span><span class="n">mi</span><span class="p">)</span><span class="w"> </span><span class="c1"># convert to miles</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## 28.26457 [mi]
</code></pre></div></div>

<p>While that’s initially concerning, a closer reading of the Wikipedia article for
the trail reveals that it was originally 40 miles long, so OSM likely includes
some of the Northern section of the trail beyond what’s officially recognized
today.</p>

<p>We should also plot the bounding box that <code class="language-plaintext highlighter-rouge">osmdata::getbb()</code> ends up generating
to ensure we’re not missing any part of the trail. We can do this with the
<code class="language-plaintext highlighter-rouge">OpenStreetMap</code> [R package](<a href="https://cran.r-project.org/package=OpenStreetMap">https://cran.r-project.org/package=OpenStreetMap</a>.
Here we unfortunately need to manually specify the bounding box as a series of
two vectors with the latitude and longitude coordinate of the upper-left and
lower-right of the box. <code class="language-plaintext highlighter-rouge">OpenStreetMap::openmap()</code> uses (latitude, longitude)
pairs, <em>not</em> (longitude, latitude) pairs as is more common in GIS, i.e.,
(y, x) not (x, y), so be sure to include them in that
order.<code class="language-plaintext highlighter-rouge">[^lat-long]</code>{markdown} <code class="language-plaintext highlighter-rouge">OpenStreetMap::openproj()</code> also requires a
<code class="language-plaintext highlighter-rouge">projection</code> argument, so I use <code class="language-plaintext highlighter-rouge">sf::st_crs(4326)$proj4string</code> to generate one
automatically, ensuring I don’t introduce a type somewhere by accident.</p>

<p><code class="language-plaintext highlighter-rouge">[^lat-long]:</code>{markdown} I spent 20 minutes not understanding why I couldn’t get this to work before I finally read the documenation. Don’t be like me, folks.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">OpenStreetMap</span><span class="p">)</span><span class="w">

</span><span class="c1">## get bounding box</span><span class="w">
</span><span class="n">unf_bb</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">getbb</span><span class="p">(</span><span class="s1">'uwharrie national forest usa'</span><span class="p">)</span><span class="w">

</span><span class="c1">## get OSM tiles</span><span class="w">
</span><span class="n">unf_tile</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">openmap</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">unf_bb</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="m">1</span><span class="p">],</span><span class="w">  </span><span class="c1"># lat</span><span class="w">
                      </span><span class="n">unf_bb</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">]),</span><span class="w"> </span><span class="c1"># long</span><span class="w">
                    </span><span class="nf">c</span><span class="p">(</span><span class="n">unf_bb</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="m">2</span><span class="p">],</span><span class="w">  </span><span class="c1"># lat</span><span class="w">
                      </span><span class="n">unf_bb</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">]),</span><span class="w"> </span><span class="c1"># long</span><span class="w">
                    </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'osm'</span><span class="p">,</span><span class="w"> </span><span class="n">mergeTiles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">

</span><span class="c1">## project map tiles and plot (OSM comes in Mercator...)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">openproj</span><span class="p">(</span><span class="n">unf_tile</span><span class="p">),</span><span class="w"> </span><span class="n">projection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">st_crs</span><span class="p">(</span><span class="m">4326</span><span class="p">)</span><span class="o">$</span><span class="n">proj4string</span><span class="p">)</span><span class="w">

</span><span class="c1">## plot trails</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">unf_trails</span><span class="o">$</span><span class="n">osm_lines</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'coral4'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/images/posts/gps-gis-osm/osm_plot-1.png" style="display: block; margin: auto;" /></p>

<p>Uh oh. We can see that we’re only getting a small portion of the total trail and
that it trails (heh) off the map on three sides. That’s not great, so let’s fix
it. We can start by looking up Uwharrie National Forest itself on the OSM
website. This gives us the boundaries of the official forest land in orange.</p>

<p><img src="/images/posts/gps-gis-osm/unf.png" alt="" /></p>

<p>We can see from the dialog on the left that the forest’s OSM ID is 2918413, so
we can use the <code class="language-plaintext highlighter-rouge">osmdata::opq_osm_id()</code> function to get the polygons for the
forest’s boundaries. Let’s grab the forest boundaries and plot them, along with
the bounding box they imply and the bounding box that resulted from
<code class="language-plaintext highlighter-rouge">osmdata::getbb()</code> (in red) for comparison.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## get Uwharrie National Forest Boundaries</span><span class="w">
</span><span class="n">unf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">opq_osm_id</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'relation'</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2918413</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">osmdata_sf</span><span class="p">()</span><span class="w">

</span><span class="c1">## plot Uwharrie National Forest polygons</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">unf</span><span class="o">$</span><span class="n">osm_multipolygons</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'lightgreen'</span><span class="p">,</span><span class="w"> </span><span class="n">border</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">bty</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'n'</span><span class="p">)</span><span class="w">

</span><span class="c1">## construct line for original bounding box</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">st_multilinestring</span><span class="p">(</span><span class="nf">list</span><span class="p">(</span><span class="n">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">unf_bb</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">unf_bb</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">],</span><span class="w">
                                      </span><span class="n">unf_bb</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">unf_bb</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">],</span><span class="w">
                                      </span><span class="n">unf_bb</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">unf_bb</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">],</span><span class="w">
                                      </span><span class="n">unf_bb</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">],</span><span class="w"> </span><span class="n">unf_bb</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">],</span><span class="w">
                                      </span><span class="n">unf_bb</span><span class="p">[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">],</span><span class="w"> </span><span class="n">unf_bb</span><span class="p">[</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">]),</span><span class="w">
                                      </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">byrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">))),</span><span class="w">
     </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'red'</span><span class="p">)</span><span class="w">

</span><span class="c1">## plot bounding box for Uwharrie National Forest polygons</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">st_as_sfc</span><span class="p">(</span><span class="n">st_bbox</span><span class="p">(</span><span class="n">unf</span><span class="o">$</span><span class="n">osm_multipolygons</span><span class="p">)),</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">

</span><span class="c1">## plot trails</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">unf_trails</span><span class="o">$</span><span class="n">osm_lines</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'coral4'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/images/posts/gps-gis-osm/bbox_plot-1.png" style="display: block; margin: auto;" /></p>

<p>Wow, we were missing a lot before. Let’s use the bounding box for the entire
forest as our new bounding box. First, we plot OSM using this new bounding box.
<code class="language-plaintext highlighter-rouge">st_bbox()</code> yields a vector of four numbers, rather than the matrix that
<code class="language-plaintext highlighter-rouge">osmdata::getbb()</code> produces, so we need to work around this and specify the
top-left and bottom-right corners of our new, bigger bounding box.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## get OSM tile for Uwharrie National Forest polygons</span><span class="w">
</span><span class="n">unf_full_tile</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">openmap</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="n">st_bbox</span><span class="p">(</span><span class="n">unf</span><span class="o">$</span><span class="n">osm_multipolygons</span><span class="p">)[</span><span class="m">4</span><span class="p">],</span><span class="w">  </span><span class="c1"># lat</span><span class="w">
                           </span><span class="n">st_bbox</span><span class="p">(</span><span class="n">unf</span><span class="o">$</span><span class="n">osm_multipolygons</span><span class="p">)[</span><span class="m">1</span><span class="p">]),</span><span class="w"> </span><span class="c1"># long</span><span class="w">
                         </span><span class="nf">c</span><span class="p">(</span><span class="n">st_bbox</span><span class="p">(</span><span class="n">unf</span><span class="o">$</span><span class="n">osm_multipolygons</span><span class="p">)[</span><span class="m">2</span><span class="p">],</span><span class="w">  </span><span class="c1"># lat</span><span class="w">
                           </span><span class="n">st_bbox</span><span class="p">(</span><span class="n">unf</span><span class="o">$</span><span class="n">osm_multipolygons</span><span class="p">)[</span><span class="m">3</span><span class="p">]),</span><span class="w"> </span><span class="c1"># long</span><span class="w">
                         </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'osm'</span><span class="p">,</span><span class="w"> </span><span class="n">mergeTiles</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">

</span><span class="c1">## project and plot OSM tile</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">openproj</span><span class="p">(</span><span class="n">unf_full_tile</span><span class="p">),</span><span class="w"> </span><span class="n">projection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">st_crs</span><span class="p">(</span><span class="m">4326</span><span class="p">)</span><span class="o">$</span><span class="n">proj4string</span><span class="p">)</span><span class="w">

</span><span class="c1">## plot trails</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">unf_trails</span><span class="o">$</span><span class="n">osm_lines</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'coral4'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/images/posts/gps-gis-osm/osm_plot_full-1.png" style="display: block; margin: auto;" /></p>

<p>That’s much better! We’re getting a lot of area beyond the trail, but it’s easy
to filter that out later so it’s better to grab too much than too little.</p>

<h3 id="the-whole-trail">The whole trail</h3>

<p>Now we can go back and grab all hiking trails in Uwharrie National Forest using
our new bounding box. <code class="language-plaintext highlighter-rouge">osmdata::opq()</code> expects a bounding box in a certain
format, so let’s inspect it to see what we’re working with and what we need to
reshape the output of <code class="language-plaintext highlighter-rouge">sf::st_bbox(unf$osm_multipolygons)</code> into:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## bbox format osmdata::opq() expects</span><span class="w">
</span><span class="n">unf_bb</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>##         min       max
## x -80.02366 -79.98366
## y  35.39514  35.43514
</code></pre></div></div>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## rearrange sf::st_bbox() output</span><span class="w">
</span><span class="n">matrix</span><span class="p">(</span><span class="n">st_bbox</span><span class="p">(</span><span class="n">unf</span><span class="o">$</span><span class="n">osm_multipolygons</span><span class="p">),</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w">
       </span><span class="n">dimnames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span><span class="w"> </span><span class="s1">'y'</span><span class="p">),</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'min'</span><span class="p">,</span><span class="w"> </span><span class="s1">'max'</span><span class="p">)))</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>##         min       max
## x -80.17085 -79.73170
## y  35.21987  35.63684
</code></pre></div></div>

<p>Note that I’m specifying row and column names when creating the new bounding
box. Without them, <code class="language-plaintext highlighter-rouge">osmdata::opq()</code> will fail! We can now plug this new bounding
box object into <code class="language-plaintext highlighter-rouge">osmdata::opq()</code> and get all hiking routes in the forest.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## get hiking trails in all of Uwharrie National Forest</span><span class="w">
</span><span class="n">unf_trails_full</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">opq</span><span class="p">(</span><span class="n">bbox</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="n">st_bbox</span><span class="p">(</span><span class="n">unf</span><span class="o">$</span><span class="n">osm_multipolygons</span><span class="p">),</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w">
                                     </span><span class="n">dimnames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span><span class="w"> </span><span class="s1">'y'</span><span class="p">),</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'min'</span><span class="p">,</span><span class="w"> </span><span class="s1">'max'</span><span class="p">))))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">add_osm_feature</span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'route'</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'hiking'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">osmdata_sf</span><span class="p">()</span><span class="w">

</span><span class="c1">## plot</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">unf_trails_full</span><span class="o">$</span><span class="n">osm_lines</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'coral4'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/images/posts/gps-gis-osm/opq_trails_full-1.png" style="display: block; margin: auto;" /></p>

<p>Now we’re getting a bunch of trails across the Pee Dee River in Morrow Mountain
State Park. Again it’s easy to drop these extra trails later, so for the moment,
more complete is better than less complete. These data come from OpenStreetMap,
so they also include lots of usuable data. Let’s take a look at the fields
included in our lines:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## inspect</span><span class="w">
</span><span class="n">glimpse</span><span class="p">(</span><span class="n">unf_trails_full</span><span class="o">$</span><span class="n">osm_lines</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>## Rows: 106
## Columns: 37
## $ osm_id            &lt;chr&gt; "32024414", "216945232", "216945234", "216945241", …
## $ name              &lt;chr&gt; "Uwharrie Trail", "Mountain Loop Trail", "Mountain …
## $ alt_name          &lt;chr&gt; "Uwharrie National Recreation Trail", NA, NA, NA, N…
## $ bicycle           &lt;chr&gt; "no", "no", "no", "no", "no", "no", "no", "no", "no…
## $ bridge            &lt;chr&gt; NA, NA, "yes", "yes", NA, NA, "boardwalk", NA, NA, …
## $ construction      &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ dog               &lt;chr&gt; NA, "leashed", "leashed", "leashed", "leashed", NA,…
## $ foot              &lt;chr&gt; "designated", "designated", "designated", "designat…
## $ footway           &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ highway           &lt;chr&gt; "path", "path", "path", "path", "path", "path", "pa…
## $ horse             &lt;chr&gt; NA, "no", "no", "no", "no", "no", NA, NA, NA, NA, "…
## $ lanes             &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ layer             &lt;chr&gt; NA, NA, "1", "1", NA, NA, "1", NA, NA, NA, NA, NA, …
## $ motor_vehicle     &lt;chr&gt; NA, "no", "no", "no", "no", "no", NA, NA, NA, NA, "…
## $ name_1            &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ oneway            &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ rcn_ref           &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ sac_scale         &lt;chr&gt; NA, "mountain_hiking", "mountain_hiking", "mountain…
## $ service           &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, "parkin…
## $ smoothness        &lt;chr&gt; NA, "bad", "good", "good", "bad", NA, NA, NA, NA, N…
## $ source            &lt;chr&gt; NA, NA, NA, NA, NA, "GPS_2009", "GPS_2009", "GPS_20…
## $ surface           &lt;chr&gt; "dirt", "ground", "wood", "wood", "ground", "ground…
## $ symbol            &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, "wh…
## $ tiger.cfcc        &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ tiger.county      &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ tiger.name_base   &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ tiger.name_base_1 &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ tiger.name_type   &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ tiger.reviewed    &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ tiger.zip_left    &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ tiger.zip_left_1  &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ tiger.zip_right   &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ tiger.zip_right_1 &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ tracktype         &lt;chr&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA,…
## $ trail_visibility  &lt;chr&gt; NA, "excellent", "excellent", "excellent", "excelle…
## $ wheelchair        &lt;chr&gt; NA, "no", "no", "no", "no", NA, NA, NA, NA, NA, "no…
## $ geometry          &lt;LINESTRING [°]&gt; LINESTRING (-80.0435 35.310..., LINESTRI…
</code></pre></div></div>

<p>We can use the “name” field to subset the data. If you were considering some
parallel or spur trails, you could use <code class="language-plaintext highlighter-rouge">sf::st_filter()</code> in combination with
`<code class="language-plaintext highlighter-rouge">sf::st_is_within_distance()</code> to instead just grab trails near your primary
trail.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## extract OSM lines and filter</span><span class="w">
</span><span class="n">ut</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">unf_trails_full</span><span class="o">$</span><span class="n">osm_lines</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">filter</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">'Uwharrie Trail'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>Now we’ve gotten the Uwharrie Trail twice. Once using a smaller bounding box
and once using a larger one. We can plot them both and see if there were any
segments the intial query missed</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## plot</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ut</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'red'</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">unf_trails</span><span class="o">$</span><span class="n">osm_lines</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'coral4'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/images/posts/gps-gis-osm/ut_full_comparison-1.png" style="display: block; margin: auto;" /></p>

<p>Luckily the initial query still picked up every segment, but that won’t always
be the case if you start with an inaccurate initial bounding box. If the entire
Uwharrie Trail wasn’t collected into a relation, we might have missed large
chunks of it on either end. Now we can use the bounding box for the Uwharrie
Trail to capture any other features we care about nearby.</p>

<h2 id="water">Water</h2>

<p>The first other feature we need is water. On any multi-day trip, being able to
refill your water is essential. The
<a href="https://wiki.openstreetmap.org/wiki/Key:waterway#Values">OSM wiki page on waterways</a>
shows us that they values we need to grab relevant water sources are <code class="language-plaintext highlighter-rouge">river</code> and
<code class="language-plaintext highlighter-rouge">stream</code>. Although not well-documented, you can supply multiple <code class="language-plaintext highlighter-rouge">value</code>
arguments to <code class="language-plaintext highlighter-rouge">osmdata::opq()</code> using <code class="language-plaintext highlighter-rouge">c()</code>. This will let us quickly and easily
grab both rivers and streams in the area.<sup id="fnref:opq-multiple" role="doc-noteref"><a href="#fn:opq-multiple" class="footnote" rel="footnote">2</a></sup></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## create bbox for just the Uwharrie Trail; no need for all water in the whole National Forest</span><span class="w">
</span><span class="n">ut_bb</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">matrix</span><span class="p">(</span><span class="n">st_bbox</span><span class="p">(</span><span class="n">ut</span><span class="p">),</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">dimnames</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">list</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span><span class="w"> </span><span class="s1">'y'</span><span class="p">),</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'min'</span><span class="p">,</span><span class="w"> </span><span class="s1">'max'</span><span class="p">)))</span><span class="w">

</span><span class="c1">## get rivers and streams and extract OSM lines</span><span class="w">
</span><span class="n">ut_water</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">opq</span><span class="p">(</span><span class="n">bbox</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ut_bb</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">add_osm_feature</span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'waterway'</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'river'</span><span class="p">,</span><span class="w"> </span><span class="s1">'stream'</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">osmdata_sf</span><span class="p">()</span><span class="w">
</span></code></pre></div></div>

<p>Our next step will be to drop any water sources more than a kilometer from the
trail. This will simplify our analysis later and also minimizes our
environmental impact. To conduct GIS operations in meters, we need to project
our data from latitude and longitude-based
<a href="https://en.wikipedia.org/wiki/World_Geodetic_System">WGS84</a> to a meter-based
coordiante reference system (CRS). The CRS database epsg.io shows that
<a href="http://epsg.io/32119">NAD83/North Carolina(EPSG:32119)</a> is the projection for
data in North Carolina, so we use <code class="language-plaintext highlighter-rouge">sf::st_transform()</code> along with <code class="language-plaintext highlighter-rouge">sf::st_crs()</code>
to project our trail and water source objects. This lets us calculate distances
in feet/meters rather than decimal degrees. We’ll use this to limit the water
features to those that fall within 1km of the trail. This way we’re not limiting
ourselves to only water features that directly intersect the trail, but we’re
also not retaining a bunch of features that are farther off-trail than I like to
hike for water.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## project trail</span><span class="w">
</span><span class="n">ut</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_transform</span><span class="p">(</span><span class="n">ut</span><span class="p">,</span><span class="w"> </span><span class="n">st_crs</span><span class="p">(</span><span class="m">32119</span><span class="p">))</span><span class="w">

</span><span class="c1">## project water sources</span><span class="w">
</span><span class="n">ut_water</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ut_water</span><span class="o">$</span><span class="n">osm_lines</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_transform</span><span class="p">(</span><span class="n">st_crs</span><span class="p">(</span><span class="m">32119</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_filter</span><span class="p">(</span><span class="n">ut</span><span class="p">,</span><span class="w"> </span><span class="n">.predicate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">st_is_within_distance</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span><span class="p">)</span><span class="w">

</span><span class="c1">## plot</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ut_water</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'lightblue'</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ut</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'coral4'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/images/posts/gps-gis-osm/water_filter-1.png" style="display: block; margin: auto;" /></p>

<h2 id="roads">Roads</h2>

<p>If we want to be near water, we want to be far from roads. OpenStreetMap has
lots of different categories of roads, so we’ll want to capture all the major
ones, as well as service roads and “tracks”, which is how OpenStreetMap
refers to forest roads.<sup id="fnref:forest-roads" role="doc-noteref"><a href="#fn:forest-roads" class="footnote" rel="footnote">3</a></sup> OSM identifies roads with
the key “highway,” and inspecting the
<a href="https://wiki.openstreetmap.org/wiki/Key:highway">OSM wiki page on roads</a> shows
us the various values we’ll need to grab all relevant roads.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## get roads, project, and limit to w/in 1000 m of trail</span><span class="w">
</span><span class="n">ut_roads</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">opq</span><span class="p">(</span><span class="n">bbox</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ut_bb</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">add_osm_feature</span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'highway'</span><span class="p">,</span><span class="w">
                  </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'primary'</span><span class="p">,</span><span class="w"> </span><span class="s1">'secondary'</span><span class="p">,</span><span class="w"> </span><span class="s1">'tertiary'</span><span class="p">,</span><span class="w"> </span><span class="s1">'residential'</span><span class="p">,</span><span class="w">
                            </span><span class="s1">'unclassified'</span><span class="p">,</span><span class="w"> </span><span class="s1">'track'</span><span class="p">,</span><span class="w"> </span><span class="s1">'service'</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">osmdata_sf</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">magrittr</span><span class="o">::</span><span class="n">extract2</span><span class="p">(</span><span class="s1">'osm_lines'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_transform</span><span class="p">(</span><span class="n">st_crs</span><span class="p">(</span><span class="m">32119</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_filter</span><span class="p">(</span><span class="n">ut</span><span class="p">,</span><span class="w"> </span><span class="n">.predicate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">st_is_within_distance</span><span class="p">,</span><span class="w"> </span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1000</span><span class="p">)</span><span class="w">

</span><span class="c1">## plot</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ut_roads</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'black'</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ut</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'coral4'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/images/posts/gps-gis-osm/ut_roads-1.png" style="display: block; margin: auto;" /></p>

<p>Note the use of <code class="language-plaintext highlighter-rouge">magrittr::extract2()</code> to extract the <code class="language-plaintext highlighter-rouge">osm_lines</code> object from
the <code class="language-plaintext highlighter-rouge">osmdata_sf</code> object returned by <code class="language-plaintext highlighter-rouge">osmdata::osmdata_sf()</code>. This is how you can
access a list element in a pipeline, and is equivalent to <code class="language-plaintext highlighter-rouge">$osm_lines</code>.</p>

<h1 id="campsites">Campsites</h1>

<p>To locate potential campsites we need to identify our priorities and use them to
define a set of rules for selecting potential sites. For this exercise, I’m
using the following:</p>

<ol>
  <li>
    <p>I’d like to be within 750 feet of a water source. Some (more hardcore)
backpackers prefer to be farther away from water sources to minimize the chance
of encountering animals. Since Uwharrie National Forest isn’t an area with
heightened bear activity, I’m willing to trade the chance of a raccoon sniffing
around my bear canister for a shorter walk to refill my water.</p>
  </li>
  <li>
    <p>The US Forest Service requires that you camp at least <a href="https://www.fs.usda.gov/visit/know-before-you-go/responsible-recreation">200 feet away from any water source</a>.
This is
<a href="https://lnt.org/why/7-principles/travel-camp-on-durable-surfaces/">good practice everywhere</a>,
but it’s required in National Forests, so we
want to make sure any potential campsites are at least 200 feet from any water
features.</p>
  </li>
  <li>
    <p>The Uwharrie Trail is a fairly heavily-trafficked trail, so I’d like to avoid
going more than 1/4 mile off-trail to find a campsite. This will minimize the
disturbance to the surrounding area.<sup id="fnref:disturbance" role="doc-noteref"><a href="#fn:disturbance" class="footnote" rel="footnote">4</a></sup> All of the
semi-official campsites on the Uwharrie Trail are a good ways off the trail
itself, so staying near the trail will contain my impact on a large scale, but
minimize it locally.</p>
  </li>
  <li>
    <p>If you’re not in a designated campsite, you should be at least
<a href="https://sectionhiker.com/campsite-regulations-the-200-foot-rule">200 feet away from any trail</a>.
Again, this seeks to minimize your impact on the area by spreading out campsites
over time.</p>
  </li>
  <li>
    <p>If I’m making the effort to carry my shelter, sleep system, and food on my
back, you better believe I don’t want to be hearing any cars at night. To try
and minimize the chances of this happening, I want to be least 1,000 feet from
any roads. The lower section of the trail skirts particularly close to a
residential neighborhood, so this is an important consideration.</p>
  </li>
  <li>
    <p>I’m going to drop any potential campsites smaller than 0.1 km^2. Choosing
where to actually pitch your tent within a potential site area requires many
considerations like drainage, wind exposure, and avoiding dead trees overhead.
This means that we want to have ample space in which to find the ideal tent
spot, so dropping small potential sites reduces the possibility of arriving at a
spot and finding that there’s no good place for your tent.</p>
  </li>
</ol>

<p>With all of those factors in mind, we can now define our potential campsites and
then narrow them down. I start by buffering the rivers and streams by 1,000 feet
with <code class="language-plaintext highlighter-rouge">sf::st_buffer()</code>, which gives us every area within 1,000 feet of a water
source. Then I move down my list of conditions, buffering the relevant feature
and using <code class="language-plaintext highlighter-rouge">sf::st_intersect()</code> when I want to ensure I stay <em>within</em> a given
distance of that feature and <code class="language-plaintext highlighter-rouge">sf::st_difference()</code> when I want to stay a given
distance <em>away</em> from that feature.</p>

<p>Since NAD83 uses meters as the unit of measurement, we need to convert these
distances in feet into meters. Again, the <code class="language-plaintext highlighter-rouge">units</code> package makes this easy with the
<code class="language-plaintext highlighter-rouge">units::set_units()</code> function.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## buffer water 750 ft</span><span class="w">
</span><span class="n">campsites</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_union</span><span class="p">(</span><span class="n">ut_water</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_buffer</span><span class="p">(</span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">units</span><span class="o">::</span><span class="n">set_units</span><span class="p">(</span><span class="m">750</span><span class="p">,</span><span class="w"> </span><span class="n">ft</span><span class="p">))</span><span class="w">

</span><span class="c1">## buffer water 200 ft and subtract</span><span class="w">
</span><span class="n">campsites</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_union</span><span class="p">(</span><span class="n">ut_water</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_buffer</span><span class="p">(</span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">units</span><span class="o">::</span><span class="n">set_units</span><span class="p">(</span><span class="m">200</span><span class="p">,</span><span class="w"> </span><span class="n">ft</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_difference</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">campsites</span><span class="p">)</span><span class="w">

</span><span class="c1">## buffer trail 1/4 mile and intersect</span><span class="w">
</span><span class="n">campsites</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_union</span><span class="p">(</span><span class="n">ut</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_buffer</span><span class="p">(</span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">units</span><span class="o">::</span><span class="n">set_units</span><span class="p">(</span><span class="m">.25</span><span class="p">,</span><span class="w"> </span><span class="n">mi</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_intersection</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">campsites</span><span class="p">)</span><span class="w">

</span><span class="c1">## buffer trail 200 ft and subtract</span><span class="w">
</span><span class="n">campsites</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_union</span><span class="p">(</span><span class="n">ut</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_buffer</span><span class="p">(</span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">units</span><span class="o">::</span><span class="n">set_units</span><span class="p">(</span><span class="m">200</span><span class="p">,</span><span class="w"> </span><span class="n">ft</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_difference</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">campsites</span><span class="p">)</span><span class="w">

</span><span class="c1">## buffer roads to 1000 ft and subtract</span><span class="w">
</span><span class="n">campsites</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">st_union</span><span class="p">(</span><span class="n">ut_roads</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_buffer</span><span class="p">(</span><span class="n">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">units</span><span class="o">::</span><span class="n">set_units</span><span class="p">(</span><span class="m">1000</span><span class="p">,</span><span class="w"> </span><span class="n">ft</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_difference</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">campsites</span><span class="p">)</span><span class="w">

</span><span class="c1">## cast multipolygon to polygons and convert to sf</span><span class="w">
</span><span class="n">campsites</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">campsites</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_cast</span><span class="p">(</span><span class="s1">'POLYGON'</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_sf</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">n</span><span class="p">())</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="c1"># create ID variable</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">st_area</span><span class="p">(</span><span class="n">.</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">units</span><span class="o">::</span><span class="n">set_units</span><span class="p">(</span><span class="m">.1</span><span class="p">,</span><span class="w"> </span><span class="n">km</span><span class="o">^</span><span class="m">2</span><span class="p">))</span><span class="w"> </span><span class="c1"># filter to &gt; .1 sq km</span><span class="w">
</span></code></pre></div></div>

<p>The animation below shows each step in the process in order:</p>

<p><img src="/images/posts/gps-gis-osm/campsites_animation-.gif" style="display: block; margin: auto;" /></p>

<h1 id="elevation">Elevation</h1>

<p>So far we haven’t really done anything that you couldn’t do on CalTopo, albeit
in a less programmatic way. Let’s change that by bringing in some elevation
data. Elevation is important when hiking because it determines how many climbs
your lungs will have to endure and how many descents your knees will. CalTopo
has great built-in tools for generating
<a href="https://training.caltopo.com/all_users/tools/measure#profile">elevation profiles</a>
and more detailed
<a href="https://training.caltopo.com/all_users/tools/measure#terrainstats">terrain statistics</a>
that can tell you what to expect along a given route. However, you can only
calculate them for lines or polygons you’ve manually drawn.</p>

<p>While we could import the potential campsite polygons we’ve just generated into
CalTopo and then calculate the terrain statistics, this has two major drawbacks.
First, you have to point and click through generating the report for each polygon
because there’s no way to batch process. Second, and more importantly, this
would use a lot of processing power and computing time on CalTopo’s servers. If,
unlike me, you have a paid subscription, you might feel less bad about this, but
I’m trying not to take advantage of such an awesome service that CalTopo
currently provides for free.</p>

<p>We can use R’s capabilities to handle
<a href="https://www.gislounge.com/geodatabases-explored-vector-and-raster-data/">raster data</a>
to solve both of these problems! The <code class="language-plaintext highlighter-rouge">elevatr</code> package lets you easily download
elevation data in the form of a
<a href="https://en.wikipedia.org/wiki/Digital_elevation_model">digital elevation model</a>.
These models combine multiple measurements from satellites to produce a single
image of the earth where the brightness of each pixel represents the elevation
of a given area. <code class="language-plaintext highlighter-rouge">elevatr</code> allows you to easily access elevation data compiled
from a number of different data sources. The main function is
<code class="language-plaintext highlighter-rouge">elevatr::get_elev_raster()</code>, which takes an <code class="language-plaintext highlighter-rouge">sf</code> object as its first argument
and <code class="language-plaintext highlighter-rouge">z</code>, z zoom level of 1:14. We can also specify the <code class="language-plaintext highlighter-rouge">clip = 'bbox'</code> argument
to crop the resulting raster to just the bounding box of our potential
campsites, and not the entire tile they fall in.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">elevatr</span><span class="p">)</span><span class="w">

</span><span class="c1">## get elevation raster and clip to bbox</span><span class="w">
</span><span class="n">elev</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">get_elev_raster</span><span class="p">(</span><span class="n">campsites</span><span class="p">,</span><span class="w"> </span><span class="n">z</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">13</span><span class="p">,</span><span class="w"> </span><span class="n">clip</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'bbox'</span><span class="p">)</span><span class="w">

</span><span class="c1">## plot to inspect</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">elev</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">grey</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="m">100</span><span class="o">/</span><span class="m">100</span><span class="p">))</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ut</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'coral4'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/images/posts/gps-gis-osm/elevation-1.png" style="display: block; margin: auto;" /></p>

<p>Since we can see that the highest point in the area is only about 300 feet above
sea level, we don’t need to worry about absolute elevation when picking
potential sites. Instead, we want to know how <em>level</em> these areas are; no one
wants to wake up smushed against the downhill wall of their tent. We can use the
<code class="language-plaintext highlighter-rouge">raster::terrain()</code> function to calculate the <em>slope</em> in each pixel.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## calculate slope</span><span class="w">
</span><span class="n">camp_slope</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">terrain</span><span class="p">(</span><span class="n">elev</span><span class="p">,</span><span class="w"> </span><span class="n">opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'slope'</span><span class="p">,</span><span class="w"> </span><span class="n">unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'degrees'</span><span class="p">)</span><span class="w">

</span><span class="c1">## plot slope</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">camp_slope</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ut</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'coral4'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/images/posts/gps-gis-osm/slope-1.png" style="display: block; margin: auto;" /></p>

<p>All that’s left to do is aggregate slope measures to each polygon, and then
calculate some sort of summary statistic to tell us how steep each potential
site is overall. I’m going to use the median of each area’s slope rather than
its average to avoid giving undue influence to outliers (if a .5 km<sup>2</sup>
area is largely flat with a cliff at one edge, then it’s likely still a good
candidate for a campsite). Let’s filter out all areas with a median slope of
more than 10°.</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## calculate median slope for each polygon and filter</span><span class="w">
</span><span class="n">campsites</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">campsites</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">mutate</span><span class="p">(</span><span class="n">med_slope</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">raster</span><span class="o">::</span><span class="n">extract</span><span class="p">(</span><span class="n">camp_slope</span><span class="p">,</span><span class="w"> </span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">fun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">median</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w">
  </span><span class="n">filter</span><span class="p">(</span><span class="n">med_slope</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w"> 
</span></code></pre></div></div>

<p>With that done, we can now plot our potential campsite locations and all the
features used to define them:</p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">## plot campsites and all features</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ut</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'n'</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">campsites</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'lightgreen'</span><span class="p">,</span><span class="w"> </span><span class="n">border</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NA</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ut_water</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'lightblue'</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ut_roads</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'black'</span><span class="p">)</span><span class="w">
</span><span class="n">plot</span><span class="p">(</span><span class="n">ut</span><span class="o">$</span><span class="n">geometry</span><span class="p">,</span><span class="w"> </span><span class="n">add</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'coral4'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p><img src="/images/posts/gps-gis-osm/plot_final-1.png" style="display: block; margin: auto;" /></p>

<p>This is a pretty picture, but it’s not very useful. To make it so that we can
actually navigate to any of these spots, we need to get them onto a topographic
map.</p>

<h1 id="plan-it">Plan it</h1>

<p>To make our map usable, all we have to do is export the potential campsite
polygons from R so that we can import them into CalTopo. CalTopo supports a
number of file formats for importing, but the one we want to use is
<a href="https://en.wikipedia.org/wiki/GeoJSON">GeoJSON</a>. We can use the <code class="language-plaintext highlighter-rouge">geojsonio</code>
package to easily convert our polygons from <code class="language-plaintext highlighter-rouge">sf</code> objects to GeoJSON format and
then save them to disk to import into CalTopo.<sup id="fnref:export" role="doc-noteref"><a href="#fn:export" class="footnote" rel="footnote">5</a></sup></p>

<p>There are two (potentially) tricky things we need to do. First, make sure we
reproject our NAD83 data back to decimal degree-based WGS84 so that CalTopo can
properly reference them. Second, we want to take advantage of R’s capabilities
to efficiently wrangle data and create a name field for our polygons so they’ll
be easy to identify and reference once they’re in CalTopo. To do this, we need
to create a “title” field in our <code class="language-plaintext highlighter-rouge">sf</code> object before we convert it to
GeoJSON.<sup id="fnref:json-field" role="doc-noteref"><a href="#fn:json-field" class="footnote" rel="footnote">6</a></sup></p>

<div class="language-r highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">geojsonio</span><span class="p">)</span><span class="w">

</span><span class="c1">## create site number field; transmute b/c all fields other than label are lost on import</span><span class="w">
</span><span class="n">campsites</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">transmute</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">str_c</span><span class="p">(</span><span class="s1">'Potential Site '</span><span class="p">,</span><span class="w"> </span><span class="n">row_number</span><span class="p">()))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_transform</span><span class="p">(</span><span class="n">st_crs</span><span class="p">(</span><span class="m">4326</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="c1"># project to WGS84</span><span class="w">
  </span><span class="n">geojson_json</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">geojson_write</span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'campsites.json'</span><span class="p">)</span><span class="w">

</span><span class="c1">## export Uwharrie Trail to save the trouble of tracing it</span><span class="w">
</span><span class="n">ut</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">st_transform</span><span class="p">(</span><span class="n">st_crs</span><span class="p">(</span><span class="m">4326</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="c1"># project to WGS84</span><span class="w">
  </span><span class="n">geojson_json</span><span class="p">()</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> 
  </span><span class="n">geojson_write</span><span class="p">(</span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'trail.json'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<p>At this point all that’s left to do is click the “Import” button in CalTopo and
select your newly created <code class="language-plaintext highlighter-rouge">.json</code> file. You can check out the potential
campsites live on CalTopo below:</p>

<iframe src="https://caltopo.com/m/HGMR" height="600px" width="100%" style="border:none;">

</iframe>

<p>Some closing thoughts viewing the potential sites in context on CalTopo:</p>

<ul>
  <li>Potential Site 2 looks promising. It’s slightly downhill from the trail, and
has some relatively flat ground. However, the water source is an intermittent
stream (denoted by the three dots in the blue line), so depending on time of
year there may not actually be easy access to water here.</li>
  <li>Potential Site 4 is located near both a perennial and an intermittent stream,
so the odds of finding a usable water source are higher. Across the trail to the
West you can see an area that meets all of our site selection criteria except
gentle slopes due to the steep rise to the 795 foot peak nearby.</li>
  <li>Potential Site 7 demonstrates the limitations of this approach because there
are two forest roads near it on the Forest Service map that aren’t included in
OpenStreetMap. Google Maps shows that there’s a <a href="https://www.google.com/maps/place/Carolina+Forest+Campground+\(Private\)/@35.3582376,-80.0380413,221m/data=!3m1!1e3!4m5!3m4!1s0x8854876fa97c332d:0xabc57da731b6d41e!8m2!3d35.3582026!4d-80.0383957">private RV campground here</a>, so best to avoid it. Doubly so because it’s largely outside of Uwharrie
National Forest’s boundaries (the green lines). This is why it’s important to
check more than just the terrain before you go!</li>
</ul>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:dispersed" role="doc-endnote">
      <p>See <a href="https://sectionhiker.com/what-is-the-difference-between-frontcountry-camping-backcountry-or-designated-campsites-and-dispersed-camping/">here</a> for a discussion of different types of campsites and contexts in which they are usually found. <a href="#fnref:dispersed" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:opq-multiple" role="doc-endnote">
      <p>If we didn’t do this, we’d have to use <code class="language-plaintext highlighter-rouge">c()</code> to combine multiple <code class="language-plaintext highlighter-rouge">osmdata_sf</code> objects and then extract the <code class="language-plaintext highlighter-rouge">osm_lines</code> object from the combined <code class="language-plaintext highlighter-rouge">osmdata_sf</code> object. <a href="#fnref:opq-multiple" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:forest-roads" role="doc-endnote">
      <p>The US Forest Service maintains GIS data on forest roads on National Forest land, but the <a href="https://data-usfs.hub.arcgis.com/datasets/national-forest-system-roads-feature-layer">API</a> to access them is…less than user friendly so I’m ignoring them for this illustration. <a href="#fnref:forest-roads" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:disturbance" role="doc-endnote">
      <p>In very sparsely-traveled areas, it can be better to seek out campsites far from the trail to avoid camping in areas where others have recently stayed. This can help prevent the emergence of ‘social’ campsites that are not officially recognized or maintained but are frequently used. It will also reduce the chance that you’ll encounter any local wildlife that have learned that such spots can be a source of easy meals. <a href="#fnref:disturbance" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:export" role="doc-endnote">
      <p>Want to find potential campsites for a trail that’s not in OpenStreetMap? CalTopo supports exports as well as imports, so you can trace the route in CalTopo, export it, then load it in R with <code class="language-plaintext highlighter-rouge">sf::st_read()</code> and then carry out the steps above! <a href="#fnref:export" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:json-field" role="doc-endnote">
      <p>CalTopo refers to an object’s name field as its “Label” in the interface, but this isn’t what it’s called under the hood. I had to export a line I create and inspect the resulting <code class="language-plaintext highlighter-rouge">.json</code> file to find out that it’s referred to as a “title” instead. <a href="#fnref:json-field" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>

        
      </section>

      <footer class="page__meta">
        
        


  




  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i> Tags: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://localhost:4000/tags/#backpacking" class="page__taxonomy-item" rel="tag">backpacking</a><span class="sep">, </span>
    
      
      
      <a href="http://localhost:4000/tags/#gis" class="page__taxonomy-item" rel="tag">GIS</a>
    
    </span>
  </p>




      </footer>

      

<section class="page__share">
  
    <h4 class="page__share-title">Share on</h4>
  

  <a href="https://twitter.com/intent/tweet?text=http://localhost:4000/posts/2021/01/gps-gis-osm" class="btn btn--twitter" title="Share on Twitter"><i class="fab fa-twitter" aria-hidden="true"></i><span> Twitter</span></a>

  <a href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/posts/2021/01/gps-gis-osm" class="btn btn--facebook" title="Share on Facebook"><i class="fab fa-facebook" aria-hidden="true"></i><span> Facebook</span></a>

  <a href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/posts/2021/01/gps-gis-osm" class="btn btn--linkedin" title="Share on LinkedIn"><i class="fab fa-linkedin" aria-hidden="true"></i><span> LinkedIn</span></a>
</section>

      


  <nav class="pagination">
    
      <a href="http://localhost:4000/posts/2020/10/jeykll-footnotes" class="pagination--pager" title="R Markdown, Jekyll, and Footnotes
">Previous</a>
    
    
      <a href="http://localhost:4000/posts/2021/05/geom-sf-facet" class="pagination--pager" title="Faceted maps in R
">Next</a>
    
  </nav>

    </div>

    
  </article>

  
  
    <div class="page__related">
      
        <h4 class="page__related-title">You May Also Enjoy</h4>
      
      <div class="grid__wrapper">
        
        
        
        
        
        
      
          
          
      
          
          
          
          
        
      
          
          
      
          
          
          
          
        
      
          
          
      
          
          
          
            





<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    

    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/posts/2021/05/geom-sf-facet" rel="permalink">Faceted maps in R
</a>
      
    </h2>
    
    
    

    
      <p class="page__date"><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2021-05-19T00:00:00-05:00">May 19, 2021</time></p>
    
    
    
    <p class="archive__item-excerpt" itemprop="description"><p>I recently needed to create a choropleth of a few different countries
for a project on targeting of UN peacekeepers by non-state armed actors
I’m working on. A
<a href="https://en.wikipedia.org/wiki/Choropleth_map">choropleth</a> is a type of
thematic map where data are aggregated up from smaller areas (or
discrete points) to larger ones and then visualized using different
colors to represent different numeric values.</p>

</p>
    
    
  </article>
</div>

            
            
          
          
        
      
          
          
      
          
          
          
          
        
      
          
          
      
          
          
          
          
        
      
          
          
      
          
          
          
            





<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    

    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/posts/2020/09/spatial-sql" rel="permalink">Working with Large Spatial Data in R
</a>
      
    </h2>
    
    
    

    
      <p class="page__date"><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2020-09-25T00:00:00-05:00">September 25, 2020</time></p>
    
    
    
    <p class="archive__item-excerpt" itemprop="description"><p>In my research I frequently work with large datasets. Sometimes that means datasets that cover <a href="/research/conflict-preemption">the entire globe</a>, and other times it means working with lots of micro-level <a href="/research/event-data">event data</a>. Usually, my computer is powerful enough to load and manipulate all of the data in R without issue. When my computer’s fallen short of the task at hand, my solution has often been to throw it at a high performance computing cluster. However, I finally ran into a situation where the data proved too large even for that approach.</p>

</p>
    
    
  </article>
</div>

            
            
          
          
        
      
          
          
      
          
          
          
          
        
      
          
          
      
          
          
          
          
        
      
          
          
      
          
          
          
          
        
      
          
          
      
          
          
          
          
        
      
          
          
      
          
          
          
          
        
      
          
          
      
          
          
          
          
        
      
          
          
      
          
          
          
          
        
      
          
          
      
          
          
          
          
        
      
          
          
      
          
          
          
          
        
      
          
          
      
          
          
          
          
        
      
          
          
      
          
          
          
          
        
      
          
          
      
          
          
          
          
        
        
        
        
        
          





<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    

    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/posts/2022/03/so-it-goes" rel="permalink">So it goes
</a>
      
    </h2>
    
    
    

    
      <p class="page__date"><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> <time datetime="2022-03-31T00:00:00-05:00">March 31, 2022</time></p>
    
    
    
    <p class="archive__item-excerpt" itemprop="description"><p>When I was applying to graduate school and asking for letters of
recommendation from my undergrad professors, one of them told me to give
academia three years, and that if I hadn’t found a permanent position by
then, to find another career. It’s been three years, and next week I
start a new job as a data scientist. I read a fair bit of <a href="https://blogs.lse.ac.uk/impactofsocialsciences/2021/08/18/reading-academic-quit-lit-how-and-why-precarious-scholars-leave-academia">quit
lit</a>
in my first couple years of grad school and always told myself that if I
went that same route, I would never pen any of my own…</p>

</p>
    
    
  </article>
</div>

        
          
      </div>
    </div>
  
</div>


    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->
<a href="/sitemap/">Sitemap</a>
<!-- end custom footer snippets -->

        

<div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>Follow:</strong></li>
    
    
    
    
      <li><a href="http://github.com/crystalamariano"><i class="fab fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    <li><a href="http://localhost:4000/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2022 Crystal A. Mariano. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://github.com/academicpages/academicpages.github.io">AcademicPages</a>, a fork of <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    <script src="http://localhost:4000/assets/js/main.min.js"></script>





  </body>
</html>

